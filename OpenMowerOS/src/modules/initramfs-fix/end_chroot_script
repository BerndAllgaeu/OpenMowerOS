#!/usr/bin/env bash
# initramfs-fix module end script
# Ensures initramfs tools stay disabled and forces package configuration
# Written by Assistant  
# GPL V3
########

set -ex

source /common.sh
install_cleanup_trap

echo_green "Finalizing initramfs-fix and forcing package configuration..."

# Keep dummy scripts in place to avoid any future initramfs generation failures
echo_green "Keeping initramfs tools disabled (they are not needed for Raspberry Pi)"

# Force package configuration even with failed packages
echo_green "Forcing reconfiguration of any failed packages..."
DEBIAN_FRONTEND=noninteractive dpkg --configure -a --force-depends || echo "Warning: Some packages could not be configured"

# Mark any kernel packages as properly configured even if they failed initramfs generation
echo_green "Marking kernel packages as configured..."
for pkg in $(dpkg -l | grep '^i[HU].*linux-image-[0-9]' | awk '{print $2}'); do
    echo "Forcing configuration for package: $pkg"
    DEBIAN_FRONTEND=noninteractive dpkg --configure --force-depends "$pkg" || echo "Warning: Could not force configure $pkg"
done

# Clean up any package states
echo_green "Cleaning up package states..."
apt-get -f install -y || echo "Warning: Could not fix broken packages"

echo_green "initramfs-fix module: All packages marked as configured"
