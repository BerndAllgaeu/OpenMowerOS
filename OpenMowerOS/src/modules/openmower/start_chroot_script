#!/usr/bin/env bash
# CustomPiOS module : openmower
# <Description what this module does>
# Written by DocGalaxyBlock (https://github.com/docgalaxyblock/)
# GPL V3
########

# Source error handling, leave this in place
set -ex

# Source CustomPIOS common.sh
source /common.sh
install_cleanup_trap

# Detect boot partition path (compatibility for newer Raspberry Pi OS)
BOOT_PATH="/boot"
if [ -d "/boot/firmware" ]; then
    BOOT_PATH="/boot/firmware"
fi

echo_green "Using boot path: $BOOT_PATH"
echo_green "Copying files to root filesystem and applying permissions..."
unpack /filesystem/root /
chown -R pi:pi /home/pi
chmod +x /home/pi/*.sh

# Create OpenMower directory in correct boot partition
mkdir -p "$BOOT_PATH/openmower"

cp /etc/comitup.conf.example "$BOOT_PATH/openmower/hotspot-example.txt"

echo_green "Get the latest mower_config.sh example..."
wget -O "$BOOT_PATH/openmower/mower_config.txt" https://raw.githubusercontent.com/ClemensElflein/open_mower_ros/main/config/mower_config.sh.example

# replace default comitup modules configs and paths
echo_green "Replace comitup path and config..."
sed -i "s|/boot/comitup.conf|$BOOT_PATH/openmower/hotspot.txt|g ; s|/boot/comitup.conf.settings-applied|$BOOT_PATH/openmower/hotspot.settings-applied|" /etc/systemd/system/comitup_config_copy.service

# Create compatibility symlink for old path if using new structure
if [ "$BOOT_PATH" = "/boot/firmware" ]; then
    echo_green "Creating compatibility symlink for old boot path..."
    # Remove existing target if it exists to avoid conflicts
    rm -rf /boot/openmower
    ln -sf "$BOOT_PATH/openmower" /boot/openmower
fi

# ensure conflicting services are masked
echo_green "ensure comitup/NetworkManager conflicting servies are masked..."
systemctl_if_exists mask dhcpd.service
systemctl_if_exists mask dhcpcd.service
systemctl_if_exists mask wpa-supplicant.service
systemctl_if_exists mask raspberrypi-net-mods.service

echo_green "Get socat for GPS redirection (debug port)..."
apt-get update --allow-releaseinfo-change
apt-get install --yes socat

echo_green "Disabling podman auto update..."
systemctl disable podman-auto-update.timer 

echo_green "Eanbling OpenMower on boot"
systemctl enable openmower

#cleanup
apt-get clean
apt-get autoremove --yes
