name: Build OpenMowerOS
on:
  workflow_dispatch:
  push:
    branches:
      - "main"
      - "development"
#      - "testing"
    paths:
      - "OpenMowerOS/src/**"
      - ".github/workflows/BuildOS.yml"
    tags-ignore:
      - "**"
  pull_request:
    types: [opened, edited, reopened, synchronize]
    paths:
      - "OpenMowerOS/src/**"
      - ".github/workflows/BuildOS.yml"

# Allow to stop obsolete workflows
concurrency:
  group: ci-buildtrain-${{ github.ref }}-1
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Cache APT packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('.github/dependencies.list') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Install Dependencies
        run: sudo apt-get update ; sudo apt-get install --yes coreutils p7zip-full qemu-user-static zip aria2

      - name: Checkout CustomPiOS
        uses: actions/checkout@v4
        with:
          repository: "guysoft/CustomPiOS"
          path: CustomPiOS

      - name: Checkout OpenMowerOS
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          path: repository
          submodules: true

      - name: Cache Raspberry Pi OS Image
        uses: actions/cache@v4
        with:
          path: repository/OpenMowerOS/src/image/
          key: raspios-image-${{ runner.os }}-${{ hashFiles('**/raspios_lite_arm64_latest.sha256') }}
          restore-keys: |
            raspios-image-${{ runner.os }}-

      - name: Download Raspberry Pi OS Source Image
        run: |
          mkdir -p repository/OpenMowerOS/src/image/
          cd repository/OpenMowerOS/src/image/
          
          # Check if we have a complete image file
          if [ -f *.img ] && [ ! -f *.aria2 ]; then
            echo "Using cached Raspberry Pi OS image"
            ls -la
          else
            echo "Downloading fresh Raspberry Pi OS image..."
            # Remove any partial downloads
            rm -f *.img.xz *.aria2
            aria2c --seed-time=0 --allow-overwrite=true https://downloads.raspberrypi.org/raspios_lite_arm64_latest.torrent
          fi

      - name: Comparing Checksums
        run: |
          cd repository/OpenMowerOS/src/image
          # Only verify checksum if we have the compressed file
          if [ -f *.img.xz ]; then
            curl -JL https://downloads.raspberrypi.org/raspios_lite_arm64_latest.sha256 | awk '{print $1"  "$2}' | sha256sum -c
          else
            echo "Skipping checksum verification for cached image"
          fi

      - name: Update CustomPiOS Paths
        run: cd repository/OpenMowerOS/src && ../../../CustomPiOS/src/update-custompios-paths

      - name: Cache Build Workspace
        uses: actions/cache@v4
        with:
          path: repository/OpenMowerOS/src/workspace/
          key: build-workspace-${{ runner.os }}-${{ hashFiles('repository/OpenMowerOS/src/modules/**') }}-${{ hashFiles('repository/OpenMowerOS/src/image/*.img') }}
          restore-keys: |
            build-workspace-${{ runner.os }}-${{ hashFiles('repository/OpenMowerOS/src/modules/**') }}-
            build-workspace-${{ runner.os }}-

      - name: Build Image
        run: sudo modprobe loop && cd repository/OpenMowerOS/src && sudo bash -x ./build_dist && cd && sudo chown -R $USER ./*

      - name: Copy output image
        run: cp ${{ github.workspace }}/repository/OpenMowerOS/src/workspace/*-raspios-*-lite.img openmoweros-raspios-lite-latest.img

      - name: Upload failed Logfile
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-failed.log
          path: repository/OpenMowerOS/src/build.log

      - name: Compress the image
        shell: bash
        run: |
          CPU_COUNT="$(nproc)"
          echo -e "\e[32mUsing ${CPU_COUNT} Cores for compression...\e[0m"
          xz -efkvz9T"${CPU_COUNT}" openmoweros-raspios-lite-latest.img

      - name: Calculating checksums
        shell: bash
        run: |
          sha256sum openmoweros-raspios-lite-latest.img > openmoweros-raspios-lite-latest.img.sha256
          sha256sum openmoweros-raspios-lite-latest.img.xz > openmoweros-raspios-lite-latest.img.xz.sha256

      - name: Upload Compressed Image
        uses: actions/upload-artifact@v4
        with:
          name: openmoweros-raspios-lite-latest.img.xz
          path: openmoweros-raspios-lite-latest.img.xz

      - name: Upload Compressed Image Checksum
        uses: actions/upload-artifact@v4
        with:
          name: openmoweros-raspios-lite-latest.img.xz.sha256
          path: openmoweros-raspios-lite-latest.img.xz.sha256

      - name: Upload Image Checksum
        uses: actions/upload-artifact@v4
        with:
          name: openmoweros-raspios-lite-latest.img.sha256
          path: openmoweros-raspios-lite-latest.img.sha256

      - name: Create Development Release
        if: github.ref == 'refs/heads/development'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "dev-${{ github.sha }}"
          name: "Development Build - ${{ github.sha }}"
          prerelease: true
          body: |
            ğŸš§ **Development Build** ğŸš§
            
            This is an automated development build from the `development` branch.
            - Commit: ${{ github.sha }}
            - Build Date: ${{ github.run_id }}
            
            âš ï¸ **Warning**: This is a development version and may contain experimental features.
            Use at your own risk. For stable releases, use the main branch builds.
            
            ## Changes in this build:
            - Latest development features and fixes
            - All community improvements included
            - OpenOCD temporarily disabled for build stability
            
            ## Supported Hardware:
            - Raspberry Pi 3, 3+, 4, 400, 5
            - Raspberry Pi Zero 2 W
            - Compute Module 3, 3+, 4
          files: |
            openmoweros-raspios-lite-latest.img.xz
            openmoweros-raspios-lite-latest.img.xz.sha256
            openmoweros-raspios-lite-latest.img.sha256

      - name: Create Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "latest"
          name: "Latest Stable OpenMowerOS Image"
          prerelease: false
          body: |
            ğŸš€ **Official OpenMowerOS Release** ğŸš€
            
            This is the latest stable release of OpenMowerOS.
            - Build Date: ${{ github.run_id }}
            - Based on Raspberry Pi OS Lite ARM64
            
            ## What's included:
            - ğŸ¤– Complete ROS2 environment for OpenMower
            - ğŸ³ Podman container support
            - ğŸ“¶ ComitUp WiFi setup (captive portal)
            - ğŸ”§ All necessary drivers and configurations
            - ğŸ› ï¸ Hardware support for multiple UART interfaces
            
            ## Supported Hardware:
            - âœ… Raspberry Pi 3, 3+, 4, 400, 5
            - âœ… Raspberry Pi Zero 2 W  
            - âœ… Compute Module 3, 3+, 4
            
            ## Installation:
            1. Download the `.img.xz` file
            2. Flash to SD card using Raspberry Pi Imager
            3. Insert SD card into your Raspberry Pi
            4. Follow OpenMower setup instructions
            
            ## Verification:
            Use the provided `.sha256` files to verify download integrity.
          files: |
            openmoweros-raspios-lite-latest.img.xz
            openmoweros-raspios-lite-latest.img.xz.sha256
            openmoweros-raspios-lite-latest.img.sha256
